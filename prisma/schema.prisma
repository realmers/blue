// Prisma schema for Better Auth
// learn more: https://better-auth.com/docs/concepts/database

generator client {
  provider = "prisma-client"
  output   = "../src/lib/generated/prisma"

  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            Int      @id @default(autoincrement()) // Matches legacy person_id
  name          String
  email         String?  @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  // Legacy Fields Merged

  username String? @unique
  surname  String?
  pnr      String?
  role_id  Int?

  sessions           Session[]
  accounts           Account[]
  role               role?                @relation(fields: [role_id], references: [role_id])
  availability       availability[]
  competence_profile competence_profile[]

  displayUsername     String?
  application_status ApplicationStatus @default(unhandled)

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
  @@index([userId])
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                Int
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
  @@index([identifier])
}

enum ApplicationStatus {
  unhandled
  accepted
  rejected
}

// New Domain Tables

model availability {
  availability_id Int       @id @default(autoincrement())
  person_id       Int?
  from_date       DateTime? @db.Date
  to_date         DateTime? @db.Date
  person          User?     @relation(fields: [person_id], references: [id], onDelete: Cascade)
}

model competence {
  competence_id      Int                  @id @default(autoincrement())
  name               String?              @db.VarChar(255)
  competence_profile competence_profile[]
}

model competence_profile {
  competence_profile_id Int         @id @default(autoincrement())
  person_id             Int?
  competence_id         Int?
  years_of_experience   Decimal?    @db.Decimal(4, 2)
  competence            competence? @relation(fields: [competence_id], references: [competence_id], onDelete: NoAction, onUpdate: NoAction)
  person                User?       @relation(fields: [person_id], references: [id], onDelete: Cascade)
}

model role {
  role_id Int     @id @default(autoincrement())
  name    String? @db.VarChar(255)
  users   User[]
}

model legacy_availability {
  availability_id Int       @id(map: "legacy_availability_pkey") @default(autoincrement())
  person_id       Int?
  from_date       DateTime? @db.Date
  to_date         DateTime? @db.Date
}

model legacy_competence {
  competence_id Int     @id(map: "legacy_competence_pkey") @default(autoincrement())
  name          String? @db.VarChar(255)
}

model legacy_competence_profile {
  competence_profile_id Int      @id(map: "legacy_competence_profile_pkey") @default(autoincrement())
  person_id             Int?
  competence_id         Int?
  years_of_experience   Decimal? @db.Decimal(4, 2)
}

model legacy_person {
  person_id Int     @id(map: "legacy_person_pkey") @default(autoincrement())
  name      String? @db.VarChar(255)
  surname   String? @db.VarChar(255)
  pnr       String? @db.VarChar(255)
  email     String? @db.VarChar(255)
  password  String? @db.VarChar(255)
  role_id   Int?
  username  String? @db.VarChar(255)
}

model legacy_role {
  role_id Int     @id(map: "legacy_role_pkey") @default(autoincrement())
  name    String? @db.VarChar(255)
}
